<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Wish Is Your Command</title>
  <script src="https://cdn.jsdelivr.net/npm/mux-embed@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #f4f4f4;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  box-sizing: border-box;
}

.card {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 400px;
  box-sizing: border-box;
  margin: 2rem;
}

.card h2 {
  margin: 0 0 1.5rem;
  text-align: center;
  font-size: 1.5rem;
}

form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 100%;
}

input[type="email"],
input[type="text"] {
  width: 100%;
  box-sizing: border-box;
  padding: 1rem;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 1.2rem;
  background: white;
}

button {
  width: 100%;
  background: #007aff;
  color: white;
  border: none;
  padding: 1rem;
  border-radius: 8px;
  font-size: 1.2rem;
  cursor: pointer;
  transition: background 0.2s ease;
}

button:hover {
  background: #006ae6;
}

.error {
  color: red;
  text-align: center;
  font-size: 0.9rem;
}

@media (max-width: 480px) {
  body {
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-start;
    height: auto;
    padding-top: 1rem;
  }

  .card {
    margin: 0;
    border-radius: 0;
    box-shadow: none;
    padding: 1rem;
  }

  .card h2 {
    font-size: 1.3rem;
  }

  input, button {
    font-size: 1.1rem;
    padding: 1rem;
  }
}

  </style>
</head>
<body>
  <h1>Your Wish Is Your Command</h1>
  <div id="videos-container"></div>

  <script>
    function toggleVideo(titleEl) {
      const wrapper = titleEl.nextElementSibling;
      const isVisible = wrapper.style.display === "block";
      wrapper.style.display = isVisible ? "none" : "block";
      titleEl.textContent = (isVisible ? '▶️ ' : '▼ ') + titleEl.textContent.slice(2);
    }

    const email = new URLSearchParams(window.location.search).get("email") || localStorage.getItem("userEmail") || "anonymous";
    localStorage.setItem("userEmail", email);

    const airtableToken = "patNGrZNwfEVXAAQQ.0b066f675070d9280cac1ff726847edb1474cbc9dae0cc8634dd5e2369cac9ae";
    const baseId = "app0nqXjYS3mdULGj";
    const tableName = "Videos";
    const makeWebhookUrl = "https://hook.us2.make.com/r5m5023uf3wh4qgymgp1wjsqmue3bd71";

    fetch(`https://api.airtable.com/v0/${baseId}/${tableName}?view=Published&sort[0][field]=Lesson%20Number&sort[0][direction]=asc`, {
      headers: {
        Authorization: `Bearer ${airtableToken}`
      }
    })
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("videos-container");

      data.records.forEach(record => {
        const title = record.fields["Title"];
        const playbackId = record.fields["Playback ID"];
        const videoId = record.id;

        const block = document.createElement("div");
        block.className = "video-block";
        block.innerHTML = `
          <div class="video-title" onclick="toggleVideo(this)">▶️ ${title}</div>
          <div class="video-wrapper">
            <video id="${videoId}" controls></video>
          </div>
        `;
        container.appendChild(block);

        const videoEl = block.querySelector("video");

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(`https://stream.mux.com/${playbackId}.m3u8`);
          hls.attachMedia(videoEl);
        } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
          videoEl.src = `https://stream.mux.com/${playbackId}.m3u8`;
        }

        setTimeout(() => {
          mux.monitor(`#${videoId}`, {
            debug: true,
            data: {
              env_key: "1mb83nn1ar08r0faf628pf2u5",
              viewer_user_id: email,
              video_id: videoId,
              video_title: title,
              player_name: "Dynamic Airtable Player",
              video_stream_type: "on-demand"
            }
          });

          const sendEvent = (eventType) => {
            fetch(makeWebhookUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                viewer_user_id: email,
                video_id: videoId,
                video_title: title,
                event_type: eventType,
                timestamp: new Date().toISOString()
              })
            });
          };

          videoEl.addEventListener("timeupdate", () => {
            const percent = (videoEl.currentTime / videoEl.duration) * 100;
            if (percent > 95 && !videoEl._sent100) {
              sendEvent("100% watched");
              videoEl._sent100 = true;
              console.log("✅ Sent: 100% watched");
            }
          });
        }, 250);
      });
    })
    .catch(err => {
      console.error("Failed to fetch Airtable data:", err);
      document.getElementById("videos-container").innerHTML = "<p style='color:red; text-align:center;'>Failed to load videos.</p>";
    });
  </script>
</body>
</html>
